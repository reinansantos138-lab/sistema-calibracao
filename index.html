<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Calibração - MQB-QGI (Nuvem)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE CONFIGURAÇÃO E INICIALIZAÇÃO -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // SUA CONFIGURAÇÃO DO FIREBASE (JÁ INSERIDA)
        const firebaseConfig = {
            apiKey: "AIzaSyCaBnWArroydId70ihZTjcxWg7xeCnTi4k",
            authDomain: "calibracao-mqb.firebaseapp.com",
            projectId: "calibracao-mqb",
            storageBucket: "calibracao-mqb.firebasestorage.app",
            messagingSenderId: "963196075933",
            appId: "1:963196075933:web:cb528d8ac0425e2e79f974"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expõe para o React (Global)
        window.firebase = {
            db,
            auth,
            signInAnonymously,
            onAuthStateChanged,
            collection,
            addDoc,
            onSnapshot,
            deleteDoc,
            doc,
            updateDoc,
            query,
            orderBy
        };
        
        // Dispara evento para avisar o React que o Firebase está pronto
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- ÍCONES ---
        const Icon = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Beaker = () => <Icon className="w-5 h-5"><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><line x1="6" y1="14" x2="18" y2="14"/></Icon>;
        const Pipette = () => <Icon className="w-5 h-5"><path d="m2 22 1-1h3l9-9"/><path d="M3 21v-3l9-9"/><path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L18 9l.9.9"/><path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L18 9l.9.9"/></Icon>;
        const Cloud = ({color}) => <Icon className={`w-5 h-5 ${color}`}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19h2a2.5 2.5 0 0 0 0-5 2.5 2.5 0 0 0 0-5 2.5 2.5 0 0 0-5 0 2.5 2.5 0 0 0-5 0 2.5 2.5 0 0 0 0 5 2.5 2.5 0 0 0 0 5h2"/></Icon>;
        const Trash2 = () => <Icon className="w-4 h-4"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Edit2 = () => <Icon className="w-4 h-4"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;
        const Download = () => <Icon className="w-4 h-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
        const FileSpreadsheet = () => <Icon className="w-4 h-4"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>;
        const Save = () => <Icon className="w-4 h-4"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const Plus = () => <Icon className="w-4 h-4"><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const X = () => <Icon className="w-4 h-4"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;

        const IMHOFF_DEFAULTS = ["0,1ml a 2,0 ml", "2,0ml a 10,0ml", "10,0ml a 40,0ml", "40,0ml a 100,00ml", "100,0ml a 1000,0ml"];

        const App = () => {
            const [items, setItems] = React.useState([]);
            const [status, setStatus] = React.useState("Carregando sistema...");
            const [isOnline, setIsOnline] = React.useState(false);
            const [user, setUser] = React.useState(null);

            const appId = 'calibracao-mqb-v1'; // ID da aplicação no banco de dados

            // --- LÓGICA DE CONEXÃO FIREBASE ---
            React.useEffect(() => {
                const initApp = async () => {
                    if (!window.firebase) {
                        setStatus("Aguardando Firebase...");
                        return;
                    }

                    const { auth, db, signInAnonymously, onAuthStateChanged, collection, query, orderBy, onSnapshot } = window.firebase;

                    try {
                        // 1. Autenticação Anônima (Necessária para acessar o banco com segurança básica)
                        setStatus("Autenticando...");
                        await signInAnonymously(auth);

                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                setIsOnline(true);
                                setStatus("Sincronizando dados...");

                                // 2. Conectar ao Banco de Dados (Firestore)
                                // Caminho: artifacts -> [ID_DO_APP] -> public -> data -> items
                                const itemsRef = collection(db, 'artifacts', appId, 'public', 'data', 'items');
                                const q = query(itemsRef, orderBy("createdAt", "desc"));

                                const unsubscribe = onSnapshot(q, (snapshot) => {
                                    const loadedItems = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                                    setItems(loadedItems);
                                    setStatus(""); // Limpa status quando carrega
                                }, (error) => {
                                    console.error("Erro no listener:", error);
                                    setStatus("Erro de permissão ou conexão.");
                                    setIsOnline(false);
                                });

                                return () => unsubscribe();
                            } else {
                                setIsOnline(false);
                                setStatus("Usuário desconectado.");
                            }
                        });
                    } catch (err) {
                        console.error("Erro na inicialização:", err);
                        setStatus("Erro ao conectar no Firebase.");
                    }
                };

                if (window.firebase) {
                    initApp();
                } else {
                    window.addEventListener('firebase-ready', initApp);
                }
            }, []);

            // --- ESTADO DO FORMULÁRIO ---
            const initialFormState = {
                categoria: 'micropipeta',
                subcategoria: 'pipeta',
                customCategoryName: '',
                nome: '',
                tag: '',
                tipo: '',
                capacidade: '',
                quantidade: '1',
                calibracaoPairs: [{ ponto: '', criterio: '' }],
                divisao: '',
                erro: '',
                forma: 'alta',
                imhoffPoints: [...IMHOFF_DEFAULTS] 
            };

            const [formData, setFormData] = React.useState(initialFormState);
            const [editingId, setEditingId] = React.useState(null);

            // --- HANDLERS ---
            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            
            const handlePairChange = (index, field, value) => {
                const newPairs = [...formData.calibracaoPairs];
                newPairs[index][field] = value;
                setFormData(prev => ({ ...prev, calibracaoPairs: newPairs }));
            };
            const addPair = () => setFormData(prev => ({ ...prev, calibracaoPairs: [...prev.calibracaoPairs, { ponto: '', criterio: '' }] }));
            const removePair = (index) => {
                if(formData.calibracaoPairs.length > 1) setFormData(prev => ({ ...prev, calibracaoPairs: prev.calibracaoPairs.filter((_, i) => i !== index) }));
            };

            const handleImhoffChange = (index, value) => {
                const newPoints = [...formData.imhoffPoints];
                newPoints[index] = value;
                setFormData(prev => ({ ...prev, imhoffPoints: newPoints }));
            };
            const addImhoffPoint = () => setFormData(prev => ({ ...prev, imhoffPoints: [...prev.imhoffPoints, ""] }));
            const removeImhoffPoint = (index) => setFormData(prev => ({ ...prev, imhoffPoints: prev.imhoffPoints.filter((_, i) => i !== index) }));

            const changeSubcategory = (sub) => {
                let novoNome = '';
                if(sub === 'imhoff') novoNome = 'Cone de Imhoff';
                if(sub === 'proveta') novoNome = 'Proveta Graduada';
                setFormData({ ...formData, subcategoria: sub, nome: novoNome });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return alert("Aguarde a conexão com o banco de dados.");

                let finalName = formData.nome;
                let finalSub = formData.subcategoria;
                if (formData.subcategoria === 'custom') {
                    if (!formData.customCategoryName) return alert("Digite o nome da categoria");
                    finalSub = formData.customCategoryName;
                }

                const itemToSave = { 
                    ...formData, 
                    subcategoria: finalSub, 
                    nome: finalName,
                    userId: user.uid, // Registra quem criou (opcional)
                    createdAt: Date.now() 
                };

                const { db, addDoc, collection, doc, updateDoc } = window.firebase;
                
                try {
                    if (editingId) {
                        // Atualizar
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'items', editingId);
                        await updateDoc(docRef, itemToSave);
                        setEditingId(null);
                    } else {
                        // Criar Novo
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'items');
                        await addDoc(colRef, itemToSave);
                    }
                    // Resetar form
                    setFormData({ ...initialFormState, categoria: formData.categoria, subcategoria: formData.subcategoria });
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    alert("Erro ao salvar. Verifique se o banco de dados está no 'Modo Teste' ou se você tem permissão.");
                }
            };

            const handleDelete = async (id) => {
                if (!window.firebase || !user) return;
                if (confirm("Remover item permanentemente?")) {
                    const { db, deleteDoc, doc } = window.firebase;
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'items', id);
                    await deleteDoc(docRef);
                    if (editingId === id) { setEditingId(null); setFormData(initialFormState); }
                }
            };

            const handleEdit = (item) => {
                const knownSubs = ['pipeta', 'proveta', 'imhoff'];
                const isCustom = item.categoria === 'vidraria' && !knownSubs.includes(item.subcategoria);
                setFormData({
                    ...initialFormState,
                    ...item,
                    subcategoria: isCustom ? 'custom' : item.subcategoria,
                    customCategoryName: isCustom ? item.subcategoria : '',
                    calibracaoPairs: item.calibracaoPairs || [{ ponto: '', criterio: '' }],
                    imhoffPoints: item.imhoffPoints || [...IMHOFF_DEFAULTS]
                });
                setEditingId(item.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // --- EXPORTAÇÃO ---
            const generateCSV = () => {
                const headers = ["Categoria", "Subcategoria", "Item", "TAG", "Tipo/Classe", "Capacidade", "Qtd", "Detalhes"];
                const rows = items.map(item => {
                    let detalhes = '';
                    let sub = item.subcategoria;
                    if (item.categoria === 'micropipeta') {
                        sub = 'Micropipeta/Dispenser';
                        detalhes = (item.calibracaoPairs || []).map(p => `Ponto: ${p.ponto} (Crit: ${p.criterio})`).join(' | ');
                    } else if (item.subcategoria === 'proveta') {
                        detalhes = `Div: ${item.divisao}; Erro: ±${item.erro}; Forma: ${item.forma}`;
                    } else if (item.subcategoria === 'imhoff') {
                        detalhes = `Faixas: ${(item.imhoffPoints || []).join(' | ')}`;
                    } else {
                        if (item.subcategoria === 'pipeta') sub = 'Pipeta/Geral';
                        detalhes = '-';
                    }
                    const escape = (t) => `"${(t||'').toString().replace(/"/g, '""')}"`;
                    return [escape(item.categoria), escape(sub), escape(item.nome), escape(item.tag), escape(item.tipo), escape(item.capacidade), escape(item.quantidade), escape(detalhes)].join(',');
                });
                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
                const link = document.createElement("a");
                link.href = encodeURI(csvContent);
                link.download = `Calibracao_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const generatePDF = () => {
                if (!window.jspdf) return alert("Carregando libs...");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16); doc.setTextColor(40); doc.text("Solicitação de Calibração", 14, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 26);
                
                let lastY = 35;
                 const micros = items.filter(i => i.categoria === 'micropipeta');
                if (micros.length > 0) {
                    doc.text("Micropipetas / Dispensers", 14, lastY);
                    doc.autoTable({
                        head: [["Instrumento", "TAG", "Cap.", "Pontos e Critérios"]],
                        body: micros.map(i => [i.nome, i.tag, i.capacidade + ' mL', (i.calibracaoPairs||[]).map(p => `${p.ponto} (Crit: ${p.criterio})`).join('\n')]),
                        startY: lastY + 2, theme: 'grid'
                    });
                    lastY = doc.lastAutoTable.finalY + 10;
                }
                const vidros = items.filter(i => i.categoria === 'vidraria');
                if (vidros.length > 0) {
                    doc.text("Vidrarias", 14, lastY);
                    doc.autoTable({
                        head: [["Item", "Subcat", "Cap.", "Detalhes", "Qtd"]],
                        body: vidros.map(i => {
                            let det = '-';
                            if(i.subcategoria==='proveta') det=`Div:${i.divisao}, Erro:±${i.erro}`;
                            if(i.subcategoria==='imhoff') det='Ver faixas padrão';
                            return [i.nome, i.subcategoria, i.capacidade, det, i.quantidade];
                        }),
                        startY: lastY + 2, theme: 'grid'
                    });
                }
                doc.save(`Pedido_Calibracao_${new Date().toISOString().slice(0,10)}.pdf`);
            };

            // --- RENDER ---
            return (
                <div className="min-h-screen p-4 md:p-8 font-sans pb-24 max-w-7xl mx-auto">
                    
                    {/* Status Bar */}
                    {status && (
                        <div className="fixed top-0 left-0 w-full bg-yellow-100 text-yellow-800 text-center text-xs py-1 z-50">
                            {status}
                        </div>
                    )}

                    <header className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 mb-6 mt-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-800 p-3 rounded-lg text-white"><Beaker /></div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900">MQB-QGI</h1>
                                <p className={`text-sm flex items-center gap-1 font-medium ${isOnline ? 'text-green-600' : 'text-slate-400'}`}>
                                    <Cloud color={isOnline ? 'text-green-600' : 'text-slate-400'} /> 
                                    {isOnline ? "Banco de Dados Conectado" : "Conectando..."}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={generateCSV} className="px-3 py-2 bg-green-600 text-white rounded-lg text-sm flex gap-2 items-center hover:bg-green-700 shadow-sm"><FileSpreadsheet /> CSV</button>
                            <button onClick={generatePDF} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm flex gap-2 items-center hover:bg-blue-700 shadow-sm"><Download /> PDF</button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-5">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 sticky top-6 p-5">
                                <div className="mb-4 pb-4 border-b border-slate-100 font-bold text-slate-700 flex items-center gap-2">
                                    {editingId ? <Edit2/> : <Plus/>} {editingId ? "Editar Item" : "Novo Item"}
                                </div>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="flex rounded-lg bg-slate-100 p-1">
                                        <button type="button" onClick={()=>setFormData({...initialFormState, categoria:'micropipeta'})} className={`flex-1 py-2 text-sm font-medium rounded transition-all ${formData.categoria==='micropipeta'?'bg-white shadow text-blue-600':'text-slate-500 hover:text-slate-700'}`}>Micropipeta</button>
                                        <button type="button" onClick={()=>setFormData({...initialFormState, categoria:'vidraria'})} className={`flex-1 py-2 text-sm font-medium rounded transition-all ${formData.categoria==='vidraria'?'bg-white shadow text-green-600':'text-slate-500 hover:text-slate-700'}`}>Vidraria</button>
                                    </div>

                                    {formData.categoria === 'vidraria' && (
                                        <div className="flex flex-wrap gap-2 text-xs">
                                            {[
                                                {id:'pipeta', l:'Geral'}, {id:'proveta', l:'Proveta'}, {id:'imhoff', l:'Imhoff'}, {id:'custom', l:'Outro +'}
                                            ].map(s => (
                                                <button key={s.id} type="button" onClick={()=>changeSubcategory(s.id)} className={`px-2 py-1 rounded border transition-colors ${formData.subcategoria===s.id?'bg-green-50 border-green-300 text-green-700 font-semibold':'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>{s.l}</button>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {formData.subcategoria === 'custom' && <div className="bg-amber-50 p-2 rounded"><label className="text-xs font-bold text-amber-700 block mb-1">Nome da Categoria</label><input required placeholder="Ex: Bureta" value={formData.customCategoryName} onChange={handleInputChange} name="customCategoryName" className="w-full p-2 border border-amber-200 rounded text-sm"/></div>}
                                    
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">Nome do Item</label><input required placeholder="Ex: Pipeta 50mL" value={formData.nome} onChange={handleInputChange} name="nome" className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"/></div>

                                    {formData.categoria === 'micropipeta' && (
                                        <>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><label className="text-xs font-bold text-slate-500 block mb-1">TAG</label><input placeholder="ID/Código" value={formData.tag} onChange={handleInputChange} name="tag" className="w-full p-2 border rounded text-sm"/></div>
                                                <div><label className="text-xs font-bold text-slate-500 block mb-1">Capacidade</label><input placeholder="mL" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-sm"/></div>
                                            </div>
                                            <div className="bg-slate-50 p-3 rounded border border-slate-200">
                                                <label className="text-xs font-bold text-slate-500 block mb-2">Pontos e Critérios</label>
                                                {formData.calibracaoPairs.map((p, i) => (
                                                    <div key={i} className="flex gap-2 mb-2">
                                                        <input placeholder="Ponto" value={p.ponto} onChange={(e)=>handlePairChange(i,'ponto',e.target.value)} className="w-1/3 p-1.5 border rounded text-xs"/>
                                                        <input placeholder="Critério" value={p.criterio} onChange={(e)=>handlePairChange(i,'criterio',e.target.value)} className="flex-1 p-1.5 border rounded text-xs"/>
                                                        <button type="button" onClick={()=>removePair(i)} className="text-red-400 hover:text-red-600"><X/></button>
                                                    </div>
                                                ))}
                                                <button type="button" onClick={addPair} className="text-xs text-blue-600 font-bold flex items-center gap-1"><Plus/> Adicionar Ponto</button>
                                            </div>
                                        </>
                                    )}

                                    {formData.subcategoria === 'proveta' && (
                                        <div className="bg-green-50 p-3 rounded border border-green-200 space-y-3">
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><label className="text-xs font-bold text-green-800 block mb-1">Capacidade</label><input placeholder="mL" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-xs"/></div>
                                                <div><label className="text-xs font-bold text-green-800 block mb-1">Divisão</label><input placeholder="mL" value={formData.divisao} onChange={handleInputChange} name="divisao" className="w-full p-2 border rounded text-xs"/></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><label className="text-xs font-bold text-green-800 block mb-1">Erro Máx</label><input placeholder="±" value={formData.erro} onChange={handleInputChange} name="erro" className="w-full p-2 border rounded text-xs"/></div>
                                                <div><label className="text-xs font-bold text-green-800 block mb-1">Forma</label><select name="forma" value={formData.forma} onChange={handleInputChange} className="w-full p-2 border rounded text-xs bg-white"><option value="alta">Alta</option><option value="baixa">Baixa</option></select></div>
                                            </div>
                                        </div>
                                    )}

                                    {formData.subcategoria === 'imhoff' && (
                                        <div className="bg-amber-50 p-3 rounded border border-amber-200">
                                            <div className="mb-2"><label className="text-xs font-bold text-amber-800 block mb-1">Capacidade</label><input placeholder="mL" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-xs"/></div>
                                            <div className="bg-white p-2 rounded text-xs space-y-2 border border-amber-100">
                                                <label className="font-bold text-amber-800">Faixas de Calibração:</label>
                                                {formData.imhoffPoints.map((pt, i) => (
                                                    <div key={i} className="flex gap-1 items-center"><span className="text-slate-400 font-mono">{i+1}.</span><input value={pt} onChange={(e)=>handleImhoffChange(i, e.target.value)} className="flex-1 border-b border-slate-200 outline-none p-1"/><button type="button" onClick={()=>removeImhoffPoint(i)} className="text-red-400 hover:text-red-600 font-bold">x</button></div>
                                                ))}
                                                <button type="button" onClick={addImhoffPoint} className="text-amber-600 font-bold mt-1 block">+ Adicionar Faixa</button>
                                            </div>
                                        </div>
                                    )}

                                    {(formData.subcategoria === 'pipeta' || formData.subcategoria === 'custom') && (
                                         <div className="grid grid-cols-2 gap-2">
                                            <div><label className="text-xs font-bold text-slate-500 block mb-1">Tipo/Classe</label><input placeholder="Ex: A" value={formData.tipo} onChange={handleInputChange} name="tipo" className="w-full p-2 border rounded text-sm"/></div>
                                            <div><label className="text-xs font-bold text-slate-500 block mb-1">Capacidade</label><input placeholder="mL" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-sm"/></div>
                                        </div>
                                    )}

                                    {formData.categoria === 'vidraria' && <div><label className="text-xs font-bold text-slate-500 block mb-1">Quantidade</label><input type="number" placeholder="1" value={formData.quantidade} onChange={handleInputChange} name="quantidade" className="w-full p-2 border rounded text-sm"/></div>}

                                    <div className="flex gap-2 pt-2">
                                        {editingId && <button type="button" onClick={()=>{setEditingId(null); setFormData(initialFormState);}} className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-300">Cancelar</button>}
                                        <button type="submit" disabled={!isOnline} className={`flex-1 py-2.5 rounded-lg text-white font-medium text-sm flex justify-center items-center gap-2 ${isOnline ? 'bg-slate-800 hover:bg-slate-900' : 'bg-slate-400 cursor-not-allowed'}`}>
                                            <Save/> {editingId ? "Salvar Alterações" : "Adicionar Item"}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div className="lg:col-span-7">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[400px]">
                                <div className="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-semibold text-slate-700">Itens no Banco de Dados</h3>
                                    <span className="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded-full">{items.length} itens</span>
                                </div>
                                
                                {items.length === 0 ? (
                                    <div className="p-10 text-center text-slate-400 flex flex-col items-center justify-center h-full">
                                        <div className="mb-2 opacity-20"><Beaker/></div>
                                        <p>{status || "Nenhum item encontrado."}</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-50 text-slate-600 border-b">
                                                <tr><th className="p-3 font-semibold">Item</th><th className="p-3 font-semibold">Detalhes</th><th className="p-3 text-right font-semibold">Ação</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50">
                                                {items.map(item => (
                                                    <tr key={item.id} className="hover:bg-blue-50/30 transition-colors">
                                                        <td className="p-3 align-top">
                                                            <div className="font-bold text-slate-700">{item.nome}</div>
                                                            <div className="text-xs text-slate-500 mt-1 flex gap-2">
                                                                <span className="bg-slate-100 px-1.5 py-0.5 rounded">{item.categoria}</span>
                                                                {item.capacidade && <span className="bg-slate-100 px-1.5 py-0.5 rounded">{item.capacidade}mL</span>}
                                                                <span className="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded border border-blue-100">Qtd: {item.quantidade}</span>
                                                            </div>
                                                        </td>
                                                        <td className="p-3 text-xs text-slate-600 max-w-xs align-top">
                                                            {item.categoria==='micropipeta' && (
                                                                <div className="space-y-1">
                                                                    <div className="font-semibold text-slate-700">TAG: {item.tag}</div>
                                                                    {(item.calibracaoPairs||[]).map((p,idx) => (
                                                                        <div key={idx} className="border-l-2 border-blue-200 pl-2">{p.ponto} <span className="text-slate-400">→</span> {p.criterio}</div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                            {item.subcategoria==='proveta' && (
                                                                <div className="grid grid-cols-2 gap-1">
                                                                    <div>Div: <b>{item.divisao}</b></div>
                                                                    <div>Erro: <b>±{item.erro}</b></div>
                                                                    <div className="col-span-2">Forma: {item.forma}</div>
                                                                </div>
                                                            )}
                                                            {item.subcategoria==='imhoff' && (
                                                                <div>
                                                                    <span className="font-semibold block mb-1">Faixas:</span>
                                                                    <div className="flex flex-wrap gap-1">
                                                                        {(item.imhoffPoints||[]).map((pt, i) => <span key={i} className="bg-amber-50 text-amber-700 border border-amber-100 px-1 rounded">{pt}</span>)}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {(item.subcategoria==='pipeta' || item.subcategoria==='custom') && item.tipo && <div>Tipo/Classe: <b>{item.tipo}</b></div>}
                                                        </td>
                                                        <td className="p-3 text-right align-top">
                                                            <div className="flex justify-end gap-2">
                                                                <button onClick={()=>handleEdit(item)} className="text-blue-500 hover:bg-blue-100 p-1.5 rounded transition-colors" title="Editar"><Edit2/></button>
                                                                <button onClick={()=>handleDelete(item.id)} className="text-red-400 hover:bg-red-100 p-1.5 rounded transition-colors" title="Excluir"><Trash2/></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>