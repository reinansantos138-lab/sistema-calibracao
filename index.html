<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Calibração - LAB MQB-QGI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE CONFIGURAÇÃO E INICIALIZAÇÃO -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // SUA CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCaBnWArroydId70ihZTjcxWg7xeCnTi4k",
            authDomain: "calibracao-mqb.firebaseapp.com",
            projectId: "calibracao-mqb",
            storageBucket: "calibracao-mqb.firebasestorage.app",
            messagingSenderId: "963196075933",
            appId: "1:963196075933:web:cb528d8ac0425e2e79f974"
        };

        // Inicializa Firebase com tratamento de erro
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // Expõe para o React (Global)
            window.firebase = {
                db,
                auth,
                signInAnonymously,
                onAuthStateChanged,
                collection,
                addDoc,
                onSnapshot,
                deleteDoc,
                doc,
                updateDoc,
                query,
                orderBy
            };
            
            // Dispara evento para avisar o React que o Firebase está pronto
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Erro crítico na inicialização do Firebase:", e);
            window.firebaseError = e.message;
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- ÍCONES ---
        const Icon = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Beaker = () => <Icon className="w-5 h-5"><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><line x1="6" y1="14" x2="18" y2="14"/></Icon>; 
        const Pipette = () => <Icon className="w-5 h-5"><path d="m2 22 1-1h3l9-9"/><path d="M3 21v-3l9-9"/><path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L18 9l.9.9"/><path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L18 9l.9.9"/></Icon>; 
        const Flask = () => <Icon className="w-5 h-5"><path d="M6 21h12a1 1 0 0 0 1-1v-2a1 1 0 0 0-.08-.38L16 11a2 2 0 0 1 0-1.62V4a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v5.38a2 2 0 0 1 0 1.62l-2.92 6.62A1 1 0 0 0 5 18v2a1 1 0 0 0 1 1Z"/><path d="M10 2h4"/></Icon>; 
        const TestTube = () => <Icon className="w-5 h-5"><path d="M21 7 7 21"/><path d="M18 10 10 18"/><path d="M6 14v7a1 1 0 0 0 1 1h7"/><path d="M14 6h7"/></Icon>; 
        const Cloud = ({color}) => <Icon className={`w-5 h-5 ${color}`}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19h2a2.5 2.5 0 0 0 0-5 2.5 2.5 0 0 0 0-5 2.5 2.5 0 0 0-5 0 2.5 2.5 0 0 0-5 0 2.5 2.5 0 0 0 0 5 2.5 2.5 0 0 0 0 5h2"/></Icon>;
        const Trash2 = () => <Icon className="w-4 h-4"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Edit2 = () => <Icon className="w-4 h-4"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;
        const Download = () => <Icon className="w-4 h-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
        const FileSpreadsheet = () => <Icon className="w-4 h-4"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>;
        const Save = () => <Icon className="w-4 h-4"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const Plus = () => <Icon className="w-4 h-4"><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const X = () => <Icon className="w-4 h-4"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;
        const AlertTriangle = () => <Icon className="w-5 h-5"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;

        const IMHOFF_DEFAULTS = ["0,1ml a 2,0 ml", "2,0ml a 10,0ml", "10,0ml a 40,0ml", "40,0ml a 100,00ml", "100,0ml a 1000,0ml"];

        const App = () => {
            const [items, setItems] = React.useState([]);
            const [status, setStatus] = React.useState("Carregando sistema...");
            const [errorMsg, setErrorMsg] = React.useState(null);
            const [isOnline, setIsOnline] = React.useState(false);
            const [user, setUser] = React.useState(null);

            const appId = 'calibracao-mqb-v1';

            // --- LÓGICA DE CONEXÃO FIREBASE ---
            React.useEffect(() => {
                const initApp = async () => {
                    if (window.firebaseError) {
                         setErrorMsg(`Erro de Configuração: ${window.firebaseError}`);
                         return;
                    }
                    if (!window.firebase) {
                        setStatus("Aguardando Firebase...");
                        return;
                    }

                    const { auth, db, signInAnonymously, onAuthStateChanged, collection, query, orderBy, onSnapshot } = window.firebase;

                    try {
                        setStatus("Autenticando...");
                        try {
                            await signInAnonymously(auth);
                        } catch (authErr) {
                            if (authErr.code === 'auth/configuration-not-found' || authErr.code === 'auth/operation-not-allowed') {
                                setErrorMsg("AÇÃO NECESSÁRIA: Ative o 'Login Anônimo' no Firebase Console em Authentication > Sign-in method.");
                                return;
                            }
                            throw authErr;
                        }

                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                setIsOnline(true);
                                setStatus("Sincronizando dados...");
                                setErrorMsg(null);

                                const itemsRef = collection(db, 'artifacts', appId, 'public', 'data', 'items');
                                const q = query(itemsRef, orderBy("createdAt", "desc"));

                                const unsubscribe = onSnapshot(q, (snapshot) => {
                                    const loadedItems = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                                    setItems(loadedItems);
                                    setStatus(""); 
                                }, (error) => {
                                    if (error.code === 'permission-denied') {
                                         setErrorMsg("Permissão Negada: Verifique se as Regras do Firestore estão em modo de teste (público).");
                                    } else {
                                         setStatus("Erro de conexão com banco de dados.");
                                    }
                                    setIsOnline(false);
                                });

                                return () => unsubscribe();
                            } else {
                                setIsOnline(false);
                                setStatus("Usuário desconectado.");
                            }
                        });
                    } catch (err) {
                        console.error("Erro geral:", err);
                        setStatus("Erro ao conectar no Firebase.");
                        setErrorMsg(err.message);
                    }
                };

                if (window.firebase) {
                    initApp();
                } else {
                    window.addEventListener('firebase-ready', initApp);
                }
            }, []);

            // --- ESTADO DO FORMULÁRIO ---
            const initialFormState = {
                categoria: 'micropipeta',
                subcategoria: 'pipeta',
                customCategoryName: '',
                nome: '',
                tag: '',
                tipo: '',
                capacidade: '',
                quantidade: '1',
                // Micropipetas
                calibracaoPairs: [{ ponto: '', criterio: '' }],
                // Vidrarias
                divisao: '',
                erroA: '', 
                erroB: '', 
                erroAlta: '', // Proveta Forma Alta
                erroBaixa: '', // Proveta Forma Baixa
                imhoffPoints: [...IMHOFF_DEFAULTS] 
            };

            const [formData, setFormData] = React.useState(initialFormState);
            const [editingId, setEditingId] = React.useState(null);

            // --- HANDLERS ---
            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            
            const handlePairChange = (index, field, value) => {
                const newPairs = [...formData.calibracaoPairs];
                newPairs[index][field] = value;
                setFormData(prev => ({ ...prev, calibracaoPairs: newPairs }));
            };
            const addPair = () => setFormData(prev => ({ ...prev, calibracaoPairs: [...prev.calibracaoPairs, { ponto: '', criterio: '' }] }));
            const removePair = (index) => {
                if(formData.calibracaoPairs.length > 1) setFormData(prev => ({ ...prev, calibracaoPairs: prev.calibracaoPairs.filter((_, i) => i !== index) }));
            };

            const handleImhoffChange = (index, value) => {
                const newPoints = [...formData.imhoffPoints];
                newPoints[index] = value;
                setFormData(prev => ({ ...prev, imhoffPoints: newPoints }));
            };
            const addImhoffPoint = () => setFormData(prev => ({ ...prev, imhoffPoints: [...prev.imhoffPoints, ""] }));
            const removeImhoffPoint = (index) => setFormData(prev => ({ ...prev, imhoffPoints: prev.imhoffPoints.filter((_, i) => i !== index) }));

            const changeSubcategory = (sub) => {
                let novoNome = '';
                if(sub === 'imhoff') novoNome = 'Cone de Imhoff';
                if(sub === 'proveta') novoNome = 'Proveta Graduada';
                setFormData({ 
                    ...initialFormState, 
                    categoria: formData.categoria, 
                    subcategoria: sub, 
                    nome: novoNome 
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return alert("Erro: Não conectado ao banco de dados.");

                let finalName = formData.nome;
                let finalSub = formData.subcategoria;
                if (formData.subcategoria === 'custom') {
                    if (!formData.customCategoryName) return alert("Digite o nome da categoria");
                    finalSub = formData.customCategoryName;
                }

                const itemToSave = { 
                    ...formData, 
                    subcategoria: finalSub, 
                    nome: finalName,
                    userId: user.uid, 
                    createdAt: Date.now() 
                };

                const { db, addDoc, collection, doc, updateDoc } = window.firebase;
                
                try {
                    if (editingId) {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'items', editingId);
                        await updateDoc(docRef, itemToSave);
                        setEditingId(null);
                    } else {
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'items');
                        await addDoc(colRef, itemToSave);
                    }
                    setFormData({ ...initialFormState, categoria: formData.categoria, subcategoria: formData.subcategoria });
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    alert("Erro ao salvar.");
                }
            };

            const handleDelete = async (id) => {
                if (!window.firebase || !user) return;
                if (confirm("Remover item permanentemente?")) {
                    const { db, deleteDoc, doc } = window.firebase;
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'items', id);
                    await deleteDoc(docRef);
                    if (editingId === id) { setEditingId(null); setFormData(initialFormState); }
                }
            };

            const handleEdit = (item) => {
                const knownSubs = ['pipeta', 'balao', 'bureta', 'proveta', 'imhoff'];
                const isCustom = item.categoria === 'vidraria' && !knownSubs.includes(item.subcategoria);
                setFormData({
                    ...initialFormState,
                    ...item,
                    subcategoria: isCustom ? 'custom' : item.subcategoria,
                    customCategoryName: isCustom ? item.subcategoria : '',
                    calibracaoPairs: item.calibracaoPairs || [{ ponto: '', criterio: '' }],
                    imhoffPoints: item.imhoffPoints || [...IMHOFF_DEFAULTS]
                });
                setEditingId(item.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // --- EXPORTAÇÃO CSV ---
            const generateCSV = () => {
                const headers = ["Categoria", "Subcategoria", "Item", "Tipo", "Capacidade", "Qtd", "Detalhes Técnicos"];
                const rows = items.map(item => {
                    let detalhes = '';
                    let sub = item.subcategoria;
                    if (item.categoria === 'micropipeta') {
                        sub = 'Micropipeta/Dispenser';
                        detalhes = (item.calibracaoPairs || []).map(p => `P: ${p.ponto} (Crit: ${p.criterio})`).join(' | ');
                    } else {
                        if (sub === 'pipeta') detalhes = `Erro A/AS: ±${item.erroA} | Erro B: ±${item.erroB}`;
                        else if (sub === 'balao') detalhes = `Erro A: ±${item.erroA}`;
                        else if (sub === 'bureta') detalhes = `Div: ${item.divisao} | Erro A/AS: ±${item.erroA} | Erro B: ±${item.erroB}`;
                        else if (sub === 'proveta') detalhes = `Div: ${item.divisao} | Erro Alta: ±${item.erroAlta} | Erro Baixa: ±${item.erroBaixa}`;
                        else if (sub === 'imhoff') detalhes = `Faixas: ${(item.imhoffPoints || []).join(' | ')}`;
                    }
                    const escape = (t) => `"${(t||'').toString().replace(/"/g, '""')}"`;
                    return [
                        escape(item.categoria), 
                        escape(sub), 
                        escape(item.nome), 
                        escape(item.tipo), 
                        escape(item.capacidade), 
                        escape(item.quantidade), 
                        escape(detalhes)
                    ].join(',');
                });
                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
                const link = document.createElement("a");
                link.href = encodeURI(csvContent);
                link.download = `Calibracao_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            // --- EXPORTAÇÃO PDF ---
            const generatePDF = () => {
                if (!window.jspdf) return alert("Carregando libs...");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16); doc.setTextColor(40); doc.text("Solicitação de Calibração", 14, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text("LAB MQB-QGI", 14, 26);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 31);
                
                let lastY = 40;
                
                // Micropipetas
                const micros = items.filter(i => i.categoria === 'micropipeta');
                if (micros.length > 0) {
                    doc.text("Micropipetas / Dispensers", 14, lastY);
                    doc.autoTable({
                        head: [["Instrumento", "TAG", "Cap.", "Pontos e Critérios"]],
                        body: micros.map(i => [i.nome, i.tag, i.capacidade + ' mL', (i.calibracaoPairs||[]).map(p => `${p.ponto} (Crit: ${p.criterio})`).join('\n')]),
                        startY: lastY + 2, theme: 'grid'
                    });
                    lastY = doc.lastAutoTable.finalY + 10;
                }
                
                // Vidrarias
                const vidros = items.filter(i => i.categoria === 'vidraria');
                if (vidros.length > 0) {
                    doc.text("Vidrarias", 14, lastY);
                    doc.autoTable({
                        head: [["Item", "Tipo", "Cap.", "Detalhes Técnicos", "Qtd"]],
                        body: vidros.map(i => {
                            let det = '-';
                            if (i.subcategoria === 'pipeta') det = `Erro A/AS: ±${i.erroA}\nErro B: ±${i.erroB}`;
                            else if (i.subcategoria === 'balao') det = `Erro A: ±${i.erroA}`;
                            else if (i.subcategoria === 'bureta') det = `Div: ${i.divisao}\nErro A/AS: ±${i.erroA}\nErro B: ±${i.erroB}`;
                            else if (i.subcategoria === 'proveta') det = `Div: ${i.divisao}\nErro Alta: ±${i.erroAlta}\nErro Baixa: ±${i.erroBaixa}`;
                            else if (i.subcategoria === 'imhoff') det = (i.imhoffPoints || []).join('\n');
                            
                            return [
                                `${i.nome} (${i.subcategoria})`, 
                                i.tipo || '-', 
                                i.capacidade + ' mL', 
                                det, 
                                i.quantidade
                            ];
                        }),
                        startY: lastY + 2, theme: 'grid'
                    });
                }
                doc.save(`Pedido_Calibracao_MQB_${new Date().toISOString().slice(0,10)}.pdf`);
            };

            // --- RENDER ---
            return (
                <div className="min-h-screen p-4 md:p-8 font-sans pb-24 max-w-7xl mx-auto">
                    
                    {errorMsg && (
                        <div className="fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-50 shadow-lg flex items-center justify-center gap-3">
                            <AlertTriangle className="text-white w-8 h-8" />
                            <div><p className="font-bold text-lg">Atenção</p><p className="text-sm">{errorMsg}</p></div>
                        </div>
                    )}
                    
                    {status && !errorMsg && (
                        <div className="fixed top-0 left-0 w-full bg-yellow-100 text-yellow-800 text-center text-xs py-1 z-40">{status}</div>
                    )}

                    <header className={`bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 mb-6 ${errorMsg ? 'mt-16' : 'mt-4'}`}>
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-800 p-3 rounded-lg text-white"><Beaker /></div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900">LAB MQB-QGI</h1>
                                <p className={`text-sm flex items-center gap-1 font-medium ${isOnline ? 'text-green-600' : 'text-slate-400'}`}>
                                    <Cloud color={isOnline ? 'text-green-600' : 'text-slate-400'} /> {isOnline ? "Conectado" : "Conectando..."}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={generateCSV} className="px-3 py-2 bg-green-600 text-white rounded-lg text-sm flex gap-2 items-center hover:bg-green-700 shadow-sm"><FileSpreadsheet /> CSV</button>
                            <button onClick={generatePDF} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm flex gap-2 items-center hover:bg-blue-700 shadow-sm"><Download /> PDF</button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-5">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 sticky top-6 p-5">
                                <div className="mb-4 pb-4 border-b border-slate-100 font-bold text-slate-700 flex items-center gap-2">
                                    {editingId ? <Edit2/> : <Plus/>} {editingId ? "Editar Item" : "Novo Item"}
                                </div>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="flex rounded-lg bg-slate-100 p-1">
                                        <button type="button" onClick={()=>setFormData({...initialFormState, categoria:'micropipeta'})} className={`flex-1 py-2 text-sm font-medium rounded transition-all ${formData.categoria==='micropipeta'?'bg-white shadow text-blue-600':'text-slate-500 hover:text-slate-700'}`}>Micropipeta</button>
                                        <button type="button" onClick={()=>setFormData({...initialFormState, categoria:'vidraria', subcategoria: 'pipeta'})} className={`flex-1 py-2 text-sm font-medium rounded transition-all ${formData.categoria==='vidraria'?'bg-white shadow text-green-600':'text-slate-500 hover:text-slate-700'}`}>Vidraria</button>
                                    </div>

                                    {formData.categoria === 'vidraria' && (
                                        <div className="flex flex-wrap gap-2 text-xs">
                                            {[
                                                {id:'pipeta', l:'Pipeta', i:<Beaker/>}, 
                                                {id:'balao', l:'Balão Vol.', i:<Flask/>},
                                                {id:'bureta', l:'Bureta', i:<TestTube/>},
                                                {id:'proveta', l:'Proveta', i:<Icon><rect width="10" height="16" x="7" y="4"/></Icon>}, 
                                                {id:'imhoff', l:'Imhoff', i:<Icon><path d="m19.5 5-9 16.6L1.5 5h18Z"/></Icon>}, 
                                                {id:'custom', l:'Outro', i:<Plus/>}
                                            ].map(s => (
                                                <button key={s.id} type="button" onClick={()=>changeSubcategory(s.id)} className={`flex items-center gap-1 px-3 py-1.5 rounded border transition-colors ${formData.subcategoria===s.id?'bg-green-50 border-green-300 text-green-700 font-bold shadow-sm':'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                                                    {s.l}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {formData.subcategoria === 'custom' && <div className="bg-amber-50 p-2 rounded"><label className="text-xs font-bold text-amber-700 block mb-1">Nome da Categoria</label><input required placeholder="Ex: Picnômetro" value={formData.customCategoryName} onChange={handleInputChange} name="customCategoryName" className="w-full p-2 border border-amber-200 rounded text-sm"/></div>}
                                    
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">Nome do Item</label><input required placeholder="Descrição" value={formData.nome} onChange={handleInputChange} name="nome" className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"/></div>

                                    {/* --- MICROPIPETA --- */}
                                    {formData.categoria === 'micropipeta' && (
                                        <>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div><label className="text-xs font-bold text-slate-500 block mb-1">TAG</label><input placeholder="ID/Código" value={formData.tag} onChange={handleInputChange} name="tag" className="w-full p-2 border rounded text-sm"/></div>
                                                <div><label className="text-xs font-bold text-slate-500 block mb-1">Capacidade</label><input placeholder="mL" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-sm"/></div>
                                            </div>
                                            <div className="bg-slate-50 p-3 rounded border border-slate-200">
                                                <label className="text-xs font-bold text-slate-500 block mb-2">Pontos e Critérios</label>
                                                {formData.calibracaoPairs.map((p, i) => (
                                                    <div key={i} className="flex gap-2 mb-2">
                                                        <input placeholder="Ponto" value={p.ponto} onChange={(e)=>handlePairChange(i,'ponto',e.target.value)} className="w-1/3 p-1.5 border rounded text-xs"/>
                                                        <input placeholder="Critério" value={p.criterio} onChange={(e)=>handlePairChange(i,'criterio',e.target.value)} className="flex-1 p-1.5 border rounded text-xs"/>
                                                        <button type="button" onClick={()=>removePair(i)} className="text-red-400 hover:text-red-600"><X/></button>
                                                    </div>
                                                ))}
                                                <button type="button" onClick={addPair} className="text-xs text-blue-600 font-bold flex items-center gap-1"><Plus/> Adicionar Ponto</button>
                                            </div>
                                        </>
                                    )}

                                    {/* --- VIDRARIAS (SÓ APARECE SE CATEGORIA FOR VIDRARIA) --- */}
                                    {formData.categoria === 'vidraria' && (
                                        <>
                                            {/* Pipeta */}
                                            {formData.subcategoria === 'pipeta' && (
                                                <div className="bg-slate-50 p-3 rounded border border-slate-200 space-y-2">
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Tipo</label><input placeholder="Ex: A" value={formData.tipo} onChange={handleInputChange} name="tipo" className="w-full p-2 border rounded text-sm"/></div>
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Capacidade (mL)</label><input placeholder="Ex: 10" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-sm"/></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Erro A/AS (±)</label><input placeholder="mL" value={formData.erroA} onChange={handleInputChange} name="erroA" className="w-full p-2 border rounded text-sm"/></div>
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Erro B (±)</label><input placeholder="mL" value={formData.erroB} onChange={handleInputChange} name="erroB" className="w-full p-2 border rounded text-sm"/></div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Balão */}
                                            {formData.subcategoria === 'balao' && (
                                                <div className="bg-slate-50 p-3 rounded border border-slate-200 space-y-2">
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Tipo</label><input placeholder="Ex: Vidro/PP" value={formData.tipo} onChange={handleInputChange} name="tipo" className="w-full p-2 border rounded text-sm"/></div>
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Capacidade (mL)</label><input placeholder="Ex: 100" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-sm"/></div>
                                                    </div>
                                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">Erro A (±)</label><input placeholder="mL" value={formData.erroA} onChange={handleInputChange} name="erroA" className="w-full p-2 border rounded text-sm"/></div>
                                                </div>
                                            )}

                                            {/* Bureta */}
                                            {formData.subcategoria === 'bureta' && (
                                                <div className="bg-slate-50 p-3 rounded border border-slate-200 space-y-2">
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Tipo</label><input placeholder="Ex: Âmbar" value={formData.tipo} onChange={handleInputChange} name="tipo" className="w-full p-2 border rounded text-sm"/></div>
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Capacidade (mL)</label><input placeholder="Ex: 50" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-sm"/></div>
                                                    </div>
                                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">Divisão (mL)</label><input placeholder="Ex: 0.1" value={formData.divisao} onChange={handleInputChange} name="divisao" className="w-full p-2 border rounded text-sm"/></div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Erro A/AS (±)</label><input placeholder="mL" value={formData.erroA} onChange={handleInputChange} name="erroA" className="w-full p-2 border rounded text-sm"/></div>
                                                        <div><label className="text-xs font-bold text-slate-500 block mb-1">Erro B (±)</label><input placeholder="mL" value={formData.erroB} onChange={handleInputChange} name="erroB" className="w-full p-2 border rounded text-sm"/></div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Proveta */}
                                            {formData.subcategoria === 'proveta' && (
                                                <div className="bg-green-50 p-3 rounded border border-green-200 space-y-3">
                                                    <div><label className="text-xs font-bold text-green-800 block mb-1">Tipo</label><input placeholder="Ex: Vidro" value={formData.tipo} onChange={handleInputChange} name="tipo" className="w-full p-2 border rounded text-xs"/></div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-xs font-bold text-green-800 block mb-1">Capacidade</label><input placeholder="mL" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-xs"/></div>
                                                        <div><label className="text-xs font-bold text-green-800 block mb-1">Divisão</label><input placeholder="mL" value={formData.divisao} onChange={handleInputChange} name="divisao" className="w-full p-2 border rounded text-xs"/></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-xs font-bold text-green-800 block mb-1">Erro (Forma Alta)</label><input placeholder="±" value={formData.erroAlta} onChange={handleInputChange} name="erroAlta" className="w-full p-2 border rounded text-xs"/></div>
                                                        <div><label className="text-xs font-bold text-green-800 block mb-1">Erro (Forma Baixa)</label><input placeholder="±" value={formData.erroBaixa} onChange={handleInputChange} name="erroBaixa" className="w-full p-2 border rounded text-xs"/></div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Imhoff */}
                                            {formData.subcategoria === 'imhoff' && (
                                                <div className="bg-amber-50 p-3 rounded border border-amber-200">
                                                    <div className="grid grid-cols-2 gap-2 mb-2">
                                                        <div><label className="text-xs font-bold text-amber-800 block mb-1">Tipo</label><input placeholder="Ex: Plástico" value={formData.tipo} onChange={handleInputChange} name="tipo" className="w-full p-2 border rounded text-xs"/></div>
                                                        <div><label className="text-xs font-bold text-amber-800 block mb-1">Capacidade</label><input placeholder="mL" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-xs"/></div>
                                                    </div>
                                                    <div className="bg-white p-2 rounded text-xs space-y-2 border border-amber-100">
                                                        <label className="font-bold text-amber-800">Faixas de Calibração:</label>
                                                        {formData.imhoffPoints.map((pt, i) => (
                                                            <div key={i} className="flex gap-1 items-center"><span className="text-slate-400 font-mono">{i+1}.</span><input value={pt} onChange={(e)=>handleImhoffChange(i, e.target.value)} className="flex-1 border-b border-slate-200 outline-none p-1"/><button type="button" onClick={()=>removeImhoffPoint(i)} className="text-red-400 hover:text-red-600 font-bold">x</button></div>
                                                        ))}
                                                        <button type="button" onClick={addImhoffPoint} className="text-amber-600 font-bold mt-1 block">+ Adicionar Faixa</button>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Custom */}
                                            {formData.subcategoria === 'custom' && (
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">Tipo</label><input placeholder="Ex: A" value={formData.tipo} onChange={handleInputChange} name="tipo" className="w-full p-2 border rounded text-sm"/></div>
                                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">Capacidade</label><input placeholder="mL" value={formData.capacidade} onChange={handleInputChange} name="capacidade" className="w-full p-2 border rounded text-sm"/></div>
                                                </div>
                                            )}
                                        </>
                                    )}

                                    {formData.categoria === 'vidraria' && <div><label className="text-xs font-bold text-slate-500 block mb-1">Quantidade</label><input type="number" placeholder="1" value={formData.quantidade} onChange={handleInputChange} name="quantidade" className="w-full p-2 border rounded text-sm"/></div>}

                                    <div className="flex gap-2 pt-2">
                                        {editingId && <button type="button" onClick={()=>{setEditingId(null); setFormData(initialFormState);}} className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-300">Cancelar</button>}
                                        <button type="submit" disabled={!isOnline} className={`flex-1 py-2.5 rounded-lg text-white font-medium text-sm flex justify-center items-center gap-2 ${isOnline ? 'bg-slate-800 hover:bg-slate-900' : 'bg-slate-400 cursor-not-allowed'}`}>
                                            <Save/> {editingId ? "Salvar Alterações" : "Adicionar Item"}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div className="lg:col-span-7">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[400px]">
                                <div className="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-semibold text-slate-700">Itens no Banco de Dados</h3>
                                    <span className="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded-full">{items.length} itens</span>
                                </div>
                                
                                {items.length === 0 ? (
                                    <div className="p-10 text-center text-slate-400 flex flex-col items-center justify-center h-full">
                                        <div className="mb-2 opacity-20"><Beaker/></div>
                                        <p>{status || "Nenhum item encontrado."}</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-50 text-slate-600 border-b">
                                                <tr><th className="p-3 font-semibold">Item</th><th className="p-3 font-semibold">Detalhes Técnicos</th><th className="p-3 text-right font-semibold">Ação</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50">
                                                {items.map(item => (
                                                    <tr key={item.id} className="hover:bg-blue-50/30 transition-colors">
                                                        <td className="p-3 align-top">
                                                            <div className="font-bold text-slate-700">{item.nome}</div>
                                                            <div className="text-xs text-slate-500 mt-1 flex gap-2 flex-wrap">
                                                                <span className="bg-slate-100 px-1.5 py-0.5 rounded capitalize">{item.subcategoria}</span>
                                                                {item.tipo && <span className="bg-slate-100 px-1.5 py-0.5 rounded">{item.tipo}</span>}
                                                                <span className="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded border border-blue-100">Qtd: {item.quantidade}</span>
                                                            </div>
                                                        </td>
                                                        <td className="p-3 text-xs text-slate-600 max-w-xs align-top">
                                                            {item.categoria === 'micropipeta' && (
                                                                <div className="space-y-1">
                                                                    <div className="font-semibold">Cap: {item.capacidade}mL | TAG: {item.tag}</div>
                                                                    {(item.calibracaoPairs||[]).map((p,idx) => (
                                                                        <div key={idx} className="border-l-2 border-blue-200 pl-2">{p.ponto} <span className="text-slate-400">→</span> {p.criterio}</div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                            
                                                            {item.subcategoria === 'pipeta' && (
                                                                <div className="space-y-1">
                                                                    <div>Cap: <b>{item.capacidade} mL</b></div>
                                                                    <div>Erro A/AS: <b>±{item.erroA}</b></div>
                                                                    <div>Erro B: <b>±{item.erroB}</b></div>
                                                                </div>
                                                            )}

                                                            {item.subcategoria === 'balao' && (
                                                                <div className="space-y-1">
                                                                    <div>Cap: <b>{item.capacidade} mL</b></div>
                                                                    <div>Erro A: <b>±{item.erroA}</b></div>
                                                                </div>
                                                            )}

                                                            {item.subcategoria === 'bureta' && (
                                                                <div className="space-y-1">
                                                                    <div>Cap: <b>{item.capacidade} mL</b> | Div: <b>{item.divisao}</b></div>
                                                                    <div>Erro A/AS: <b>±{item.erroA}</b></div>
                                                                    <div>Erro B: <b>±{item.erroB}</b></div>
                                                                </div>
                                                            )}

                                                            {item.subcategoria === 'proveta' && (
                                                                <div className="grid grid-cols-2 gap-1">
                                                                    <div>Div: <b>{item.divisao}</b></div>
                                                                    <div className="col-span-2">Alta: <b>±{item.erroAlta}</b> | Baixa: <b>±{item.erroBaixa}</b></div>
                                                                </div>
                                                            )}
                                                            {item.subcategoria === 'imhoff' && (
                                                                <div>
                                                                    <span className="font-semibold block mb-1">Cap: {item.capacidade} | Faixas:</span>
                                                                    <div className="flex flex-wrap gap-1">
                                                                        {(item.imhoffPoints||[]).map((pt, i) => <span key={i} className="bg-amber-50 text-amber-700 border border-amber-100 px-1 rounded">{pt}</span>)}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {item.subcategoria === 'custom' && <div>Cap: {item.capacidade} | Tipo: {item.tipo}</div>}
                                                        </td>
                                                        <td className="p-3 text-right align-top">
                                                            <div className="flex justify-end gap-2">
                                                                <button onClick={()=>handleEdit(item)} className="text-blue-500 hover:bg-blue-100 p-1.5 rounded transition-colors" title="Editar"><Edit2/></button>
                                                                <button onClick={()=>handleDelete(item.id)} className="text-red-400 hover:bg-red-100 p-1.5 rounded transition-colors" title="Excluir"><Trash2/></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>